# .github/workflows/release.yaml

name: Android Release Build

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    # These permissions are required for the release action to create a release and for the commit step to push changes.
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        # We need to fetch the full history to create tags and push changes back.
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@v1

      - name: Extract Java version from build files
        id: get_java_version
        run: |
          # This script attempts to find the Java version specified in your Gradle files.
          RAW_VERSION=$( (grep -r "JavaVersion.VERSION_" . --include "build.gradle*"; grep -r "jvmTarget" . --include "build.gradle*") | grep -o -E "VERSION_[0-9]+|['\"][0-9\.]+" | head -1)
          if [[ -z "$RAW_VERSION" ]]; then
            echo "⚠️ Could not determine Java version automatically. Defaulting to Java 17."
            VERSION=17
          else
            VERSION=$(echo "$RAW_VERSION" | grep -o -E '[0-9\.]+' | sed 's/_/./g')
          fi
          if [[ "$VERSION" == "1.8" ]]; then
            VERSION=8
          fi
          echo "Detected Java version: $VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ steps.get_java_version.outputs.version }}
          cache: 'gradle'

      - name: Determine Version
        id: versioning
        run: |
          # Base version for pre-releases
          BASE_VERSION_NAME="1.1"

          # Create unique version using run number
          NEW_VERSION_NAME="${BASE_VERSION_NAME}.${{ github.run_number }}"
          # Use run number as versionCode to ensure it increases
          NEW_VERSION_CODE=${{ github.run_number }}

          echo "Version: $NEW_VERSION_NAME (Code: $NEW_VERSION_CODE)"
          
          # Set outputs for subsequent steps
          echo "new_version_name=$NEW_VERSION_NAME" >> "$GITHUB_OUTPUT"
          echo "new_version_code=$NEW_VERSION_CODE" >> "$GITHUB_OUTPUT"

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew
      
      - name: Configure Gradle Properties
        run: |
          mkdir -p ~/.gradle
          echo "org.gradle.jvmargs=-Xmx3072m" >> ~/.gradle/gradle.properties
          echo "android.useAndroidX=true" >> ~/.gradle/gradle.properties
      
      - name: Build with Gradle
        run: ./gradlew clean assembleRelease -PversionCode=${{ steps.versioning.outputs.new_version_code }} -PversionName=${{ steps.versioning.outputs.new_version_name }}

      - name: Rename APK
        id: rename_apk
        run: |
          # Find the unsigned APK
          APK_PATH=$(find ./app/build/outputs/apk/release -name "app-release-unsigned.apk")
          APK_DIR=$(dirname "$APK_PATH")
          
          # Create the new filename
          NEW_APK_NAME="app-release-unsigned-v${{ steps.versioning.outputs.new_version_name }}.apk"
          
          # Rename the file
          mv "$APK_PATH" "$APK_DIR/$NEW_APK_NAME"
          
          # Set output for the upload step
          echo "new_path=$APK_DIR/$NEW_APK_NAME" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Pre-Release
        uses: softprops/action-gh-release@v1
        with:
          # The name of the tag for this release
          tag_name: v${{ steps.versioning.outputs.new_version_name }}
          # The name of the release
          name: Release v${{ steps.versioning.outputs.new_version_name }}
          # Mark this release as a pre-release
          prerelease: true
          # A list of files to upload as assets to the release
          files: ${{ steps.rename_apk.outputs.new_path }}
        env:
          # This token is provided by Actions and is required to create a release
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
