name: Merged Build & Release

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

# âš¡ Concurrency: Cancels the entire job if a new push comes in.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      checks: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@v1

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: Increment version
        id: versioning
        run: |
          # Define the path to your app's build.gradle file
          GRADLE_FILE="app/build.gradle.kts"

          # Extract current version code and name
          CURRENT_VERSION_CODE=$(grep 'versionCode ' $GRADLE_FILE | awk '{print $2}')
          CURRENT_VERSION_NAME=$(grep 'versionName ' $GRADLE_FILE | awk '{print $2}' | tr -d '"')

          # Increment versionCode
          NEW_VERSION_CODE=$((CURRENT_VERSION_CODE + 1))

          # Increment patch number in versionName (e.g., 1.2.3 -> 1.2.4)
          NEW_VERSION_NAME=$(echo $CURRENT_VERSION_NAME | awk -F. -v OFS=. '{$NF = $NF + 1;} 1')

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: false

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        id: gradle-build
        run: |
          set +e
          export BUILD_NUMBER=$(git rev-list --count HEAD)

          # Build the APK
          ./gradlew assembleDebug -PversionBuild=$BUILD_NUMBER --build-cache > build.log 2>&1

          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          cat build.log
          exit $EXIT_CODE

      # ------------------------------------------------------------------
      # FAILURE HANDLING
      # ------------------------------------------------------------------
      - name: Report Failure to Jules
        if: failure() && steps.gradle-build.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let logTail = 'Log file not found.';
            try { logTail = fs.readFileSync('build.log', 'utf8').slice(-4000); } catch (e) {}

            const assignee = 'gemini-code-assist';

            try {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Build Failure on ${context.eventName === 'pull_request' ? 'PR #' + context.issue.number : context.ref}`,
                body: `@${assignee} /jules debug this build error\n\n**Log:**\n\`\`\`\n${logTail}\n\`\`\``,
                labels: ['jules', 'bug'],
                assignees: [assignee]
              });
            } catch (error) {
              console.log("Failed to create issue with assignee. Retrying without assignee.");
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Build Failure on ${context.eventName === 'pull_request' ? 'PR #' + context.issue.number : context.ref}`,
                body: `@${assignee} /jules debug this build error\n\n**Log:**\n\`\`\`\n${logTail}\n\`\`\``,
                labels: ['jules', 'bug']
              });
            }

      # ------------------------------------------------------------------
      # RELEASE STEPS (Only run on PUSH, not Pull Requests)
      # ------------------------------------------------------------------
      - name: Prepare Release Variables
        if: success() && github.event_name == 'push'
        id: release_vars
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add app/build.gradle.kts
          # Commit only if there are changes
          if ! git diff --staged --quiet; then
            git commit -m "chore(release): Bump version to ${{ steps.versioning.outputs.new_version_name }}"
            git tag v${{ steps.versioning.outputs.new_version_name }}
            git push
            git push --tags
          else
            PATCH=$(grep 'patch=' version.properties | cut -d'=' -f2)
          fi

          VERSION_NAME="$MAJOR.$MINOR.$PATCH.$BUILD_NUMBER"
          
          TAG_NAME="latest-debug-v${MAJOR}.${MINOR}"
          
          # Dynamic App Name from settings.gradle
          if [ -f "settings.gradle.kts" ]; then
             APP_NAME=$(grep 'rootProject.name' settings.gradle.kts | sed -E "s/.*=.*[\"'](.*)[\"']/\1/")
          elif [ -f "settings.gradle" ]; then
             APP_NAME=$(grep 'rootProject.name' settings.gradle | sed -E "s/.*=.*[\"'](.*)[\"']/\1/")
          else
             APP_NAME="App"
          fi

          # Locate built APK
          APK_ORIGINAL=$(find app/build/outputs/apk/debug -name "*.apk" | head -n 1)
          
          if [ -z "$APK_ORIGINAL" ]; then
             echo "Error: No APK found to release!"
             exit 1
          fi

          TARGET_NAME="${APP_NAME}-${VERSION_NAME}-debug.apk"

          # Rename for release
          mv "$APK_ORIGINAL" "$TARGET_NAME"

          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "APK_FILE=$TARGET_NAME" >> $GITHUB_ENV

      - name: Publish Release
        if: success() && github.event_name == 'push'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Force update tag to point to current commit
          git tag -fa $TAG_NAME -m "Latest Debug Build"
          git push origin $TAG_NAME --force

          # Check if release exists
          if gh release view $TAG_NAME > /dev/null 2>&1; then
             echo "Updating existing release..."
             gh release edit $TAG_NAME --prerelease \
               --title "Latest Debug Build ($TAG_NAME)" \
               --notes "Auto-build from commit $GITHUB_SHA" \
               --target $GITHUB_SHA
             gh release upload $TAG_NAME "$APK_FILE" --clobber
          else
             echo "Creating new release..."
             gh release create $TAG_NAME "$APK_FILE" --prerelease \
               --title "Latest Debug Build ($TAG_NAME)" \
               --notes "Auto-build from commit $GITHUB_SHA" \
               --target $GITHUB_SHA
          fi
